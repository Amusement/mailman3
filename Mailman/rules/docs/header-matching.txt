Header matching
===============

Mailman can do pattern based header matching during its normal rule
processing.  There is a set of site-wide default header matchines specified in
the configuaration file under the HEADER_MATCHES variable.

    >>> from Mailman.app.lifecycle import create_list
    >>> mlist = create_list(u'_xtest@example.com')

Because the default HEADER_MATCHES variable is empty when the configuration
file is read, we'll just extend the current header matching chain with a
pattern that matches 4 or more stars, discarding the message if it hits.

    >>> from Mailman.configuration import config
    >>> chain = config.chains['header-match']
    >>> chain.extend('x-spam-score', '[*]{4,}', 'discard')

First, if the message has no X-Spam-Score header, the message passes through
the chain untouched (i.e. no disposition).

    >>> msg = message_from_string("""\
    ... From: aperson@example.com
    ... To: _xtest@example.com
    ... Subject: Not spam
    ... Message-ID: <one>
    ...
    ... This is a message.
    ... """)

    >>> from Mailman.app.chains import process

Pass through is seen as nothing being in the log file after processing.

    # XXX This checks the vette log file because there is no other evidence
    # that this chain has done anything.
    >>> import os
    >>> fp = open(os.path.join(config.LOG_DIR, 'vette'))
    >>> fp.seek(0, 2)
    >>> file_pos = fp.tell()
    >>> process(mlist, msg, {}, 'header-match')
    >>> fp.seek(file_pos)
    >>> print 'LOG:', fp.read()
    LOG:
    <BLANKLINE>

Now, if the header exists but does not match, then it also passes through
untouched.

    >>> msg['X-Spam-Score'] = '***'
    >>> del msg['subject']
    >>> msg['Subject'] = 'This is almost spam'
    >>> del msg['message-id']
    >>> msg['Message-ID'] = '<two>'
    >>> file_pos = fp.tell()
    >>> process(mlist, msg, {}, 'header-match')
    >>> fp.seek(file_pos)
    >>> print 'LOG:', fp.read()
    LOG:
    <BLANKLINE>

But now if the header matches, then the message gets discarded.

    >>> msg['X-Spam-Score'] = '****'
    >>> del msg['subject']
    >>> msg['Subject'] = 'This is spam, but barely'
    >>> del msg['message-id']
    >>> msg['Message-ID'] = '<three>'
    >>> file_pos = fp.tell()
    >>> process(mlist, msg, {}, 'header-match')
    >>> fp.seek(file_pos)
    >>> print 'LOG:', fp.read()
    LOG: ... DISCARD: <three>
    <BLANKLINE>

For kicks, let's show a message that's really spammy.

    >>> msg['X-Spam-Score'] = '**********'
    >>> del msg['subject']
    >>> msg['Subject'] = 'This is really spammy'
    >>> del msg['message-id']
    >>> msg['Message-ID'] = '<four>'
    >>> file_pos = fp.tell()
    >>> process(mlist, msg, {}, 'header-match')
    >>> fp.seek(file_pos)
    >>> print 'LOG:', fp.read()
    LOG: ... DISCARD: <four>
    <BLANKLINE>

